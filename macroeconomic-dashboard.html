<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Macroeconomic Dashboard</title>
  <style>
    :root {
      --bg-primary:    #0f1117;
      --bg-secondary:  #1a1d27;
      --bg-header:     #13161f;
      --bg-cell:       #1e2130;
      --bg-label:      #161925;
      --border:        #2a2d3e;
      --text-primary:  #e2e8f0;
      --text-muted:    #64748b;
      --text-dim:      #94a3b8;
      --color-good:    #22c55e;
      --color-warn:    #f59e0b;
      --color-bad:     #ef4444;
      --color-neutral: #94a3b8;
      --color-accent:  #6366f1;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: var(--bg-header);
      border-bottom: 1px solid var(--border);
      padding: 1.25rem 1.5rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    header h1 {
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    header h1 span {
      color: var(--color-accent);
    }

    #data-period {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-secondary);
      padding: 0.25rem 0.625rem;
      border-radius: 999px;
      border: 1px solid var(--border);
    }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      flex: 1;
      padding: 1.5rem;
    }

    /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      min-height: 50vh;
    }

    .spinner {
      width: 3rem;
      height: 3rem;
      border: 3px solid var(--border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #loading p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* â”€â”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #error {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      min-height: 50vh;
      text-align: center;
    }

    #error-icon {
      font-size: 2.5rem;
    }

    #error-msg {
      color: var(--color-bad);
      font-size: 0.95rem;
      max-width: 28rem;
    }

    #retry-btn {
      background: var(--color-accent);
      color: #fff;
      border: none;
      padding: 0.5rem 1.25rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    #retry-btn:hover { opacity: 0.85; }

    /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #dashboard {
      display: none;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 680px;
    }

    /* Column header row */
    thead tr th {
      background: var(--bg-header);
      padding: 0.875rem 1rem;
      text-align: center;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    thead tr th:first-child {
      text-align: left;
      background: var(--bg-label);
      position: sticky;
      left: 0;
      z-index: 2;
      min-width: 11rem;
    }

    .country-flag {
      font-size: 1.1rem;
      display: block;
      margin-bottom: 0.2rem;
    }

    .country-name {
      display: block;
    }

    /* Data rows */
    tbody tr {
      border-bottom: 1px solid var(--border);
    }

    tbody tr:last-child { border-bottom: none; }

    tbody tr:hover td { background: rgba(255,255,255,0.025); }

    /* Sticky label column */
    tbody tr td:first-child {
      position: sticky;
      left: 0;
      z-index: 1;
      background: var(--bg-label);
      border-right: 1px solid var(--border);
      padding: 1rem 1.1rem;
    }

    tbody tr:hover td:first-child { background: var(--bg-label); }

    .indicator-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
    }

    .indicator-unit {
      font-size: 0.68rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    /* Value cells */
    tbody tr td {
      padding: 0.75rem 0.875rem;
      text-align: center;
      vertical-align: middle;
    }

    .cell-inner {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
      min-width: 5.5rem;
    }

    .cell-value {
      font-size: 1.25rem;
      font-weight: 700;
      line-height: 1;
      letter-spacing: -0.02em;
    }

    .cell-unit {
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .cell-year {
      position: absolute;
      top: -0.35rem;
      right: -0.5rem;
      font-size: 0.55rem;
      font-weight: 600;
      background: rgba(255,255,255,0.07);
      color: var(--text-muted);
      padding: 0.1rem 0.3rem;
      border-radius: 999px;
      white-space: nowrap;
    }

    .good    { color: var(--color-good); }
    .warn    { color: var(--color-warn); }
    .bad     { color: var(--color-bad); }
    .neutral { color: var(--color-neutral); }

    /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .legend-dot {
      width: 0.55rem;
      height: 0.55rem;
      border-radius: 50%;
    }

    /* â”€â”€ Bond Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-divider {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1.5rem 0 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-dim);
    }

    .section-note {
      font-weight: 400;
      color: var(--text-muted);
    }

    .bond-footnote {
      font-size: 0.68rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      padding: 1rem 1.5rem;
      text-align: center;
      font-size: 0.72rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border);
    }

    footer a {
      color: var(--color-accent);
      text-decoration: none;
    }

    footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<header>
  <h1>Macro<span>Economic</span> Dashboard</h1>
  <span id="data-period">Loadingâ€¦</span>
</header>

<main>
  <!-- Loading -->
  <section id="loading">
    <div class="spinner"></div>
    <p>Fetching macroeconomic dataâ€¦</p>
  </section>

  <!-- Error -->
  <section id="error">
    <div id="error-icon">âš ï¸</div>
    <p id="error-msg">Unable to load data. Check your internet connection.</p>
    <button id="retry-btn">Retry</button>
  </section>

  <!-- Dashboard -->
  <section id="dashboard">
    <div class="table-wrapper">
      <table id="main-table">
        <thead>
          <tr>
            <th>Indicator</th>
            <!-- country headers injected by JS -->
          </tr>
        </thead>
        <tbody>
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>

    <div class="legend">
      <span>Color key:</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--color-good)"></span>Good</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--color-warn)"></span>Caution</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--color-bad)"></span>Concern</span>
      <span class="legend-item"><span class="legend-dot" style="background:var(--color-neutral)"></span>Neutral / N/A</span>
    </div>
    <p class="bond-footnote">EU = Germany (DEU) as proxy. Source: OECD Economic Outlook (Nov 2025) via Vercel proxy. Government debt N/A for China and India.</p>

    <div class="section-divider">
      <span>Bond Markets</span>
      <span class="section-note">10-year government bond yield (monthly) Â· Source: OECD</span>
    </div>
    <div class="table-wrapper" id="bond-table-wrapper">
      <table id="bond-table">
        <thead>
          <tr>
            <th>Indicator</th>
            <!-- country headers injected by JS -->
          </tr>
        </thead>
        <tbody>
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
    <p class="bond-footnote">EU column = Germany (DEU) as proxy. China not available (not OECD member).</p>

    <div class="section-divider">
      <span>Energy</span>
      <span class="section-note">Total primary energy consumption (all sources) Â· Source: World Bank</span>
    </div>
    <div class="table-wrapper" id="energy-table-wrapper">
      <table id="energy-table">
        <thead><tr><th>Indicator</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <p class="bond-footnote">Derived from World Bank energy use per capita (EG.USE.PCAP.KG.OE) Ã— population (SP.POP.TOTL). EU = European Union aggregate.</p>

    <section>
      <div class="section-divider">
        <span>Freight</span>
        <span class="section-note">Transport volumes Â· Source: World Bank</span>
      </div>
      <div class="table-wrapper" id="freight-table-wrapper">
        <table id="freight-table">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="bond-footnote">Rail: million ton-km on domestic rail network (primarily internal). Air: million ton-km by country-registered carriers (primarily international). Sea: TEU container port throughput (international). Merch. Exports/Imports: BoP merchandise goods trade in current USD â€” compare directly with Sea Freight to gauge volume vs. value. EU = European Union aggregate.</p>
    </section>
  </section>
</main>

<footer>
  Macro: <a href="https://www.oecd.org/economic-outlook/" target="_blank" rel="noopener">OECD Economic Outlook</a> via Vercel proxy Â·
  Bonds: <a href="https://data.oecd.org/" target="_blank" rel="noopener">OECD</a> Â·
  Energy &amp; Freight: <a href="https://data.worldbank.org/" target="_blank" rel="noopener">World Bank</a>.
  Values represent most recent available year. All rights reserved by respective data providers.
</footer>

<script>
  /* â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const COUNTRIES = [
    { code: 'US', name: 'USA',   flag: 'ğŸ‡ºğŸ‡¸' },
    { code: 'CN', name: 'China', flag: 'ğŸ‡¨ğŸ‡³' },
    { code: 'EU', name: 'EU',    flag: 'ğŸ‡ªğŸ‡º' },
    { code: 'JP', name: 'Japan', flag: 'ğŸ‡¯ğŸ‡µ' },
    { code: 'IN', name: 'India', flag: 'ğŸ‡®ğŸ‡³' },
    { code: 'GB', name: 'UK',    flag: 'ğŸ‡¬ğŸ‡§' },
  ];

  const INDICATORS = [
    {
      id:    'NY.GDP.MKTP.KD.ZG',
      label: 'GDP Growth Rate',
      unit:  '% annual',
      fmt:   v => v.toFixed(1),
      color: v => {
        if (v >= 3)  return 'good';
        if (v >= 0)  return 'warn';
        return 'bad';
      },
    },
    {
      id:    'FP.CPI.TOTL.ZG',
      label: 'Inflation Rate (CPI)',
      unit:  '% annual',
      fmt:   v => v.toFixed(1),
      color: v => {
        if (v < 0 || v > 6) return 'bad';
        if (v <= 3)          return 'good';
        return 'warn';
      },
    },
    {
      id:    'SL.UEM.TOTL.ZS',
      label: 'Unemployment Rate',
      unit:  '% of labor force',
      fmt:   v => v.toFixed(1),
      color: v => {
        if (v <= 4)  return 'good';
        if (v <= 7)  return 'warn';
        return 'bad';
      },
    },
    {
      id:    'BN.CAB.XOKA.GD.ZS',
      label: 'Current Account Balance',
      unit:  '% of GDP',
      fmt:   v => (v >= 0 ? '+' : '') + v.toFixed(1),
      color: v => {
        if (v >= 1)   return 'good';
        if (v >= -2)  return 'warn';
        if (v >= -5)  return 'warn';  // deep negative still warn
        return 'bad';
      },
    },
    {
      id:    'GC.DOD.TOTL.GD.ZS',
      label: 'Government Debt',
      unit:  '% of GDP',
      fmt:   v => v.toFixed(0),
      color: v => {
        if (v < 40)   return 'good';
        if (v < 70)   return 'neutral';
        if (v < 100)  return 'warn';
        return 'bad';
      },
    },
  ];

  const KTOE_TO_TWH = 0.01163;

  const WB_API_BASE = 'https://api.worldbank.org/v2';
  const WB_COUNTRY_PARAM = COUNTRIES.map(c => c.code).join(';');

  // OECD country code mapping (null = not an OECD member â†’ show N/A)
  const OECD_COUNTRY_MAP = { US: 'USA', CN: 'CHN', EU: 'DEU', JP: 'JPN', IN: 'IND', GB: 'GBR' };

  /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let isFetching = false;

  /* â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const $loading   = document.getElementById('loading');
  const $error     = document.getElementById('error');
  const $errorMsg  = document.getElementById('error-msg');
  const $dashboard = document.getElementById('dashboard');
  const $period    = document.getElementById('data-period');
  const $thead     = document.querySelector('#main-table thead tr');
  const $tbody     = document.querySelector('#main-table tbody');
  const $retry     = document.getElementById('retry-btn');

  $retry.addEventListener('click', init);

  /* â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showLoading() {
    $loading.style.display   = 'flex';
    $error.style.display     = 'none';
    $dashboard.style.display = 'none';
  }

  function showError(msg) {
    $loading.style.display   = 'none';
    $error.style.display     = 'flex';
    $dashboard.style.display = 'none';
    $errorMsg.textContent    = msg || 'Unexpected error occurred.';
  }

  function showDashboard() {
    $loading.style.display   = 'none';
    $error.style.display     = 'none';
    $dashboard.style.display = 'block';
  }

  /* â”€â”€ Fetch macro indicators directly from OECD Economic Outlook â”€ */
  const OECD_EO_URL =
    'https://sdmx.oecd.org/public/rest/data/OECD.ECO.MAD,DSD_EO@DF_EO/' +
    'USA+CHN+DEU+JPN+IND+GBR.GDPV_ANNPCT+CPI+UNR+CBGDPR+GGFLQ.A' +
    '?startPeriod=2022&format=jsondata';

  const MEASURE_TO_IND = {
    GDPV_ANNPCT: 'NY.GDP.MKTP.KD.ZG',
    CPI:         'FP.CPI.TOTL.ZG',
    UNR:         'SL.UEM.TOTL.ZS',
    CBGDPR:      'BN.CAB.XOKA.GD.ZS',
    GGFLQ:       'GC.DOD.TOTL.GD.ZS',
  };
  const OECD_TO_DASH = { USA:'US', CHN:'CN', DEU:'EU', JPN:'JP', IND:'IN', GBR:'GB' };

  async function fetchIMFMacro() {
    const res = await fetch(OECD_EO_URL, { headers: { Accept: 'application/json' } });
    if (!res.ok) throw new Error(`OECD EO HTTP ${res.status}`);
    const json = await res.json();

    const data    = json.data;
    const struct  = data.structures[0];
    const areaDim = struct.dimensions.series[0];
    const measDim = struct.dimensions.series[1];
    const timeDim = struct.dimensions.observation[0];
    const areaVals = areaDim.values;
    const measVals = measDim.values;
    const timeVals = timeDim.values;

    const raw = {};
    for (const meas of measVals) raw[meas.id] = {};

    for (const [key, series] of Object.entries(data.dataSets[0].series)) {
      const parts    = key.split(':');
      const oecdArea = areaVals[parseInt(parts[0])].id;
      const oecdMeas = measVals[parseInt(parts[1])].id;
      const dashCode = OECD_TO_DASH[oecdArea];
      if (!dashCode) continue;
      raw[oecdMeas][dashCode] ??= {};
      for (const [tidx, obs] of Object.entries(series.observations)) {
        if (!obs || obs[0] === null || obs[0] === undefined) continue;
        const period = timeVals[parseInt(tidx)].id;
        if (period.includes('-')) continue;
        raw[oecdMeas][dashCode][period] = obs[0];
      }
    }

    const combined = {};
    for (const [oecdMeas, wbId] of Object.entries(MEASURE_TO_IND)) {
      combined[wbId] = {};
      for (const c of COUNTRIES) {
        const yearMap = raw[oecdMeas]?.[c.code] ?? {};
        // Cap at 2025 â€” exclude further-out projections (2026, 2027)
        const years   = Object.keys(yearMap).filter(y => parseInt(y) <= 2025).sort();
        if (oecdMeas === 'CPI') {
          if (years.length < 2) { combined[wbId][c.code] = { value: null, year: null }; continue; }
          const latest = years[years.length - 1];
          const prev   = years[years.length - 2];
          combined[wbId][c.code] = { value: (yearMap[latest] / yearMap[prev] - 1) * 100, year: latest };
        } else {
          const latest = years[years.length - 1] ?? null;
          combined[wbId][c.code] = latest
            ? { value: yearMap[latest], year: latest }
            : { value: null, year: null };
        }
      }
    }

    return INDICATORS.map(ind => combined[ind.id] ?? {});
  }

  /* â”€â”€ Fetch OECD 10Y bond yields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchBondYields() {
    const codes = Object.values(OECD_COUNTRY_MAP).filter(Boolean).join('+');
    const url =
      `https://sdmx.oecd.org/public/rest/data/OECD.SDD.STES,DSD_STES@DF_FINMARK,4.0/` +
      `${codes}.M.IRLT..........?startPeriod=2024-06&format=jsondata`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`OECD HTTP ${res.status}`);
    const json = await res.json();

    const data     = json.data;
    const struct   = data.structures[0];
    const areaDim  = struct.dimensions.series[0];   // REF_AREA is first series dim
    const timeDim  = struct.dimensions.observation[0]; // TIME_PERIOD

    const timePeriods = timeDim.values; // [{id:"2023"}, {id:"2022"}, ...] â€” unordered

    const seriesData = data.dataSets[0].series;
    const result = {};

    for (const [key, series] of Object.entries(seriesData)) {
      const areaIdx = parseInt(key.split(':')[0], 10);
      const locCode = areaDim.values[areaIdx].id;

      // Skip aggregates (e.g. WXOECD)
      if (!Object.values(OECD_COUNTRY_MAP).includes(locCode)) continue;

      // Find the latest non-null observation by actual year value
      const obs = series.observations;
      let best = null;
      for (const [idxStr, entry] of Object.entries(obs)) {
        if (!entry || entry[0] === null || entry[0] === undefined) continue;
        const year = timePeriods[parseInt(idxStr, 10)].id;
        if (!best || year > best.year) {
          best = { value: entry[0], year };
        }
      }
      result[locCode] = best;
    }

    // The combined multi-country OECD query returns incomplete data for DEU/GBR/CHN.
    // Fix: fetch each individually so OECD returns the full series per country.
    const [deuFallback, gbrFallback, chnFallback] = await Promise.allSettled([
      fetchOECDSingle('DEU'),
      fetchOECDSingle('GBR'),
      fetchOECDSingle('CHN')
    ]);

    if (deuFallback.status === 'fulfilled' && deuFallback.value) {
      const existing = result['DEU'];
      if (!existing || deuFallback.value.year > existing.year)
        result['DEU'] = deuFallback.value;
    }
    if (gbrFallback.status === 'fulfilled' && gbrFallback.value) {
      const existing = result['GBR'];
      if (!existing || gbrFallback.value.year > existing.year)
        result['GBR'] = gbrFallback.value;
    }
    if (chnFallback.status === 'fulfilled' && chnFallback.value) {
      const existing = result['CHN'];
      if (!existing || chnFallback.value.year > existing.year)
        result['CHN'] = chnFallback.value;
    }

    return result;
  }

  /* â”€â”€ Individual OECD query (works around combined-query data gaps) â”€â”€ */
  async function fetchOECDSingle(countryCode) {
    const url =
      `https://sdmx.oecd.org/public/rest/data/OECD.SDD.STES,DSD_STES@DF_FINMARK,4.0/` +
      `${countryCode}.M.IRLT..........?startPeriod=2024-06&format=jsondata`;
    const res = await fetch(url);
    if (!res.ok) return null;
    const json = await res.json();
    const struct = json.data.structures[0];
    const td = struct.dimensions.observation[0].values;
    const series = Object.values(json.data.dataSets[0].series)[0];
    let best = null;
    for (const [idxStr, entry] of Object.entries(series.observations)) {
      if (!entry || entry[0] === null) continue;
      const period = td[parseInt(idxStr, 10)].id;
      if (!best || period > best.year) best = { value: entry[0], year: period };
    }
    return best;
  }

  /* â”€â”€ Color-code 10Y bond yield â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function bondYieldColor(v) {
    if (v < 1)  return 'neutral';  // near-zero / deflation risk
    if (v < 4)  return 'good';     // normal developed-economy range
    if (v < 7)  return 'warn';     // elevated
    return 'bad';                  // very high / fiscal stress
  }

  /* â”€â”€ Fetch total primary energy consumption â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchEnergyData() {
    // EG.USE.COMM.KT.OE was archived. Compute total = per-capita Ã— population.
    // EG.USE.PCAP.KG.OE = energy use in kg of oil equivalent per person (kgoe/person)
    // SP.POP.TOTL        = population (persons)
    // total TWh = (kgoe/person Ã— persons) / 1,000,000 ktoe * 0.01163 TWh/ktoe

    async function fetchLatest(indicatorId) {
      const url =
        `${WB_API_BASE}/country/${WB_COUNTRY_PARAM}/indicator/${indicatorId}` +
        `?format=json&mrv=5&per_page=50`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${indicatorId}`);
      const dataArray = (await res.json())[1] ?? [];
      const map = {};
      for (const item of dataArray) {
        if (item.value === null || item.value === undefined) continue;
        const code = (item.countryiso3166alpha2 ?? item.country?.id ?? '').toUpperCase();
        if (!code) continue;
        if (!map[code] || item.date > map[code].year) {
          map[code] = { value: item.value, year: item.date };
        }
      }
      return map;
    }

    const [energyPerCapita, population] = await Promise.all([
      fetchLatest('EG.USE.PCAP.KG.OE'),
      fetchLatest('SP.POP.TOTL'),
    ]);

    const map = {};
    for (const c of COUNTRIES) {
      const epc = energyPerCapita[c.code];
      const pop = population[c.code];
      if (!epc || !pop) continue;
      // kgoe/person Ã— persons Ã· 1,000,000 = ktoe; ktoe Ã— 0.01163 = TWh
      map[c.code] = {
        value: (epc.value * pop.value / 1_000_000) * KTOE_TO_TWH,
        year: epc.year,
      };
    }
    return map;
  }

  /* â”€â”€ Build energy table DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildEnergyTable(energyData) {
    const thead = document.querySelector('#energy-table thead tr');
    const tbody = document.querySelector('#energy-table tbody');

    // Headers
    thead.innerHTML = '<th>Indicator</th>';
    for (const c of COUNTRIES) {
      const th = document.createElement('th');
      th.innerHTML =
        `<span class="country-flag">${c.flag}</span>` +
        `<span class="country-name">${c.name}</span>`;
      thead.appendChild(th);
    }

    // Single data row
    tbody.innerHTML = '';
    const tr = document.createElement('tr');

    const labelTd = document.createElement('td');
    labelTd.innerHTML =
      `<div class="indicator-name">Total Energy Use</div>` +
      `<div class="indicator-unit">TWh</div>`;
    tr.appendChild(labelTd);

    for (const c of COUNTRIES) {
      const td = document.createElement('td');
      const entry = energyData[c.code];

      if (!entry || entry.value === null || entry.value === undefined) {
        td.innerHTML =
          `<div class="cell-inner">` +
            `<span class="cell-value neutral">N/A</span>` +
          `</div>`;
      } else {
        const disp = Math.round(entry.value).toLocaleString();
        td.innerHTML =
          `<div class="cell-inner">` +
            `<span class="cell-value neutral">${disp}</span>` +
            `<span class="cell-unit">TWh</span>` +
            `<span class="cell-year">${entry.year}</span>` +
          `</div>`;
      }
      tr.appendChild(td);
    }

    tbody.appendChild(tr);
  }

  /* â”€â”€ Fetch freight volumes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchFreightData() {
    async function fetchLatest(indicatorId) {
      const url = `${WB_API_BASE}/country/${WB_COUNTRY_PARAM}/indicator/${indicatorId}`
        + `?format=json&mrv=5&per_page=50`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} for ${indicatorId}`);
      const dataArray = (await res.json())[1] ?? [];
      const map = {};
      for (const item of dataArray) {
        if (item.value === null || item.value === undefined) continue;
        const code = (item.countryiso3166alpha2 ?? item.country?.id ?? '').toUpperCase();
        if (!code) continue;
        if (!map[code] || item.date > map[code].year) {
          map[code] = { value: item.value, year: item.date };
        }
      }
      return map;
    }

    const [railData, airData, seaData, exportData, importData] = await Promise.all([
      fetchLatest('IS.RRS.GOOD.MT.K6'),
      fetchLatest('IS.AIR.GOOD.MT.K1'),
      fetchLatest('IS.SHP.GOOD.TU'),
      fetchLatest('BX.GSR.MRCH.CD'),
      fetchLatest('BM.GSR.MRCH.CD'),
    ]);
    return { railData, airData, seaData, exportData, importData };
  }

  /* â”€â”€ Format large freight numbers as K / M / B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function fmtFreight(v) {
    if (v >= 1e9)  return (v / 1e9).toFixed(2) + 'B';
    if (v >= 1e6)  return (v / 1e6).toFixed(2) + 'M';
    if (v >= 1e3)  return (v / 1e3).toFixed(1) + 'K';
    return Math.round(v).toString();
  }

  /* â”€â”€ Format USD trade values as $B / $T â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function fmtUSD(v) {
    if (v >= 1e12) return '$' + (v / 1e12).toFixed(2) + 'T';
    if (v >= 1e9)  return '$' + (v / 1e9).toFixed(1) + 'B';
    if (v >= 1e6)  return '$' + (v / 1e6).toFixed(1) + 'M';
    return '$' + Math.round(v).toLocaleString('en-US');
  }

  /* â”€â”€ Build freight table DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildFreightTable({ railData, airData, seaData, exportData, importData }) {
    const thead = document.querySelector('#freight-table thead tr');
    const tbody = document.querySelector('#freight-table tbody');

    thead.innerHTML = '<th>Indicator</th>';
    for (const c of COUNTRIES) {
      const th = document.createElement('th');
      th.innerHTML = `<span class="country-flag">${c.flag}</span><span class="country-name">${c.name}</span>`;
      thead.appendChild(th);
    }

    tbody.innerHTML = '';

    const rows = [
      { label: 'Rail Freight',     unit: 'M ton-km',      data: railData,    fmt: fmtFreight },
      { label: 'Air Freight',      unit: 'M ton-km',      data: airData,     fmt: fmtFreight },
      { label: 'Sea Freight',      unit: 'TEU',            data: seaData,     fmt: fmtFreight },
      { label: 'Merch. Exports',   unit: 'goods, current $', data: exportData, fmt: fmtUSD },
      { label: 'Merch. Imports',   unit: 'goods, current $', data: importData, fmt: fmtUSD },
    ];

    for (const row of rows) {
      const tr = document.createElement('tr');
      const labelTd = document.createElement('td');
      labelTd.innerHTML = `<div class="indicator-name">${row.label}</div><div class="indicator-unit">${row.unit}</div>`;
      tr.appendChild(labelTd);

      for (const c of COUNTRIES) {
        const td = document.createElement('td');
        const entry = row.data[c.code];
        if (!entry || entry.value === null || entry.value === undefined) {
          td.innerHTML = `<div class="cell-inner"><span class="cell-value neutral">N/A</span></div>`;
        } else {
          const disp = row.fmt(entry.value);
          td.innerHTML =
            `<div class="cell-inner">` +
              `<span class="cell-value neutral">${disp}</span>` +
              `<span class="cell-unit">${row.unit}</span>` +
              `<span class="cell-year">${entry.year}</span>` +
            `</div>`;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  /* â”€â”€ Build bond table DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildBondTable(bondData) {
    const wrapper = document.getElementById('bond-table-wrapper');
    const thead = document.querySelector('#bond-table thead tr');
    const tbody = document.querySelector('#bond-table tbody');

    // Headers (same countries as main table)
    thead.innerHTML = '<th>Indicator</th>';
    for (const c of COUNTRIES) {
      const th = document.createElement('th');
      th.innerHTML =
        `<span class="country-flag">${c.flag}</span>` +
        `<span class="country-name">${c.name}</span>`;
      thead.appendChild(th);
    }

    // Single data row
    tbody.innerHTML = '';
    const tr = document.createElement('tr');

    const labelTd = document.createElement('td');
    labelTd.innerHTML =
      `<div class="indicator-name">10Y Bond Yield</div>` +
      `<div class="indicator-unit">% per year</div>`;
    tr.appendChild(labelTd);

    for (const c of COUNTRIES) {
      const td = document.createElement('td');
      const oecdCode = OECD_COUNTRY_MAP[c.code];

      if (!oecdCode) {
        // Not an OECD member (China)
        td.innerHTML =
          `<div class="cell-inner">` +
            `<span class="cell-value neutral">N/A</span>` +
          `</div>`;
      } else {
        const entry = bondData[oecdCode];
        if (!entry || entry.value === null || entry.value === undefined) {
          td.innerHTML =
            `<div class="cell-inner">` +
              `<span class="cell-value neutral">N/A</span>` +
            `</div>`;
        } else {
          const cls  = bondYieldColor(entry.value);
          const disp = entry.value.toFixed(2);
          td.innerHTML =
            `<div class="cell-inner">` +
              `<span class="cell-value ${cls}">${disp}</span>` +
              `<span class="cell-unit">% / yr</span>` +
              `<span class="cell-year">${entry.year}</span>` +
            `</div>`;
        }
      }
      tr.appendChild(td);
    }

    tbody.appendChild(tr);
  }

  /* â”€â”€ Build table DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildTable(results) {
    // Collect all years for the period badge
    const years = new Set();
    for (const map of results) {
      for (const entry of Object.values(map)) {
        if (entry.year) years.add(entry.year);
      }
    }
    const sortedYears = [...years].sort();
    if (sortedYears.length === 0) {
      $period.textContent = 'Data period: unavailable';
    } else if (sortedYears.length === 1) {
      $period.textContent = `Data period: ${sortedYears[0]}`;
    } else {
      $period.textContent =
        `Data period: ${sortedYears[0]}â€“${sortedYears[sortedYears.length - 1]}`;
    }

    // Header columns
    $thead.innerHTML = '<th>Indicator</th>';
    for (const c of COUNTRIES) {
      const th = document.createElement('th');
      th.innerHTML =
        `<span class="country-flag">${c.flag}</span>` +
        `<span class="country-name">${c.name}</span>`;
      $thead.appendChild(th);
    }

    // Data rows
    $tbody.innerHTML = '';
    INDICATORS.forEach((ind, i) => {
      const tr = document.createElement('tr');

      // Label cell
      const labelTd = document.createElement('td');
      labelTd.innerHTML =
        `<div class="indicator-name">${ind.label}</div>` +
        `<div class="indicator-unit">${ind.unit}</div>`;
      tr.appendChild(labelTd);

      // Value cells per country
      for (const c of COUNTRIES) {
        const td = document.createElement('td');
        const entry = results[i][c.code];

        if (!entry || entry.value === null || entry.value === undefined) {
          td.innerHTML =
            `<div class="cell-inner">` +
              `<span class="cell-value neutral">N/A</span>` +
            `</div>`;
        } else {
          const cls  = ind.color(entry.value);
          const disp = ind.fmt(entry.value);
          td.innerHTML =
            `<div class="cell-inner">` +
              `<span class="cell-value ${cls}">${disp}</span>` +
              `<span class="cell-unit">${ind.unit}</span>` +
              `<span class="cell-year">${entry.year}</span>` +
            `</div>`;
        }
        tr.appendChild(td);
      }

      $tbody.appendChild(tr);
    });
  }

  /* â”€â”€ Main init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function init() {
    if (isFetching) return;
    isFetching = true;
    showLoading();

    try {
      const [wbResults, bondData, energyData, freightData] = await Promise.all([
        fetchIMFMacro(),
        fetchBondYields().catch(err => {
          console.warn('Bond data fetch failed:', err);
          return null;
        }),
        fetchEnergyData().catch(err => {
          console.warn('Energy data fetch failed:', err);
          return null;
        }),
        fetchFreightData().catch(err => {
          console.warn('Freight fetch failed:', err);
          return null;
        }),
      ]);

      buildTable(wbResults);

      if (bondData) {
        buildBondTable(bondData);
      } else {
        document.getElementById('bond-table-wrapper').innerHTML =
          `<p style="padding:1.25rem;color:var(--text-muted);font-size:0.85rem;">` +
          `Bond data unavailable â€” OECD API could not be reached.</p>`;
      }

      if (energyData) {
        buildEnergyTable(energyData);
      } else {
        document.getElementById('energy-table-wrapper').innerHTML =
          `<p style="padding:1.25rem;color:var(--text-muted);font-size:0.85rem;">` +
          `Energy data unavailable â€” World Bank API could not be reached.</p>`;
      }

      if (freightData) {
        buildFreightTable(freightData);
      } else {
        document.getElementById('freight-table-wrapper').innerHTML =
          `<p style="padding:1.25rem;color:var(--text-muted);font-size:0.85rem;">` +
          `Freight data unavailable â€” World Bank API could not be reached.</p>`;
      }

      showDashboard();
    } catch (err) {
      console.error(err);
      showError(
        `Failed to load data: ${err.message}. ` +
        `Check your internet connection and try again.`
      );
    } finally {
      isFetching = false;
    }
  }

  init();
</script>
</body>
</html>
